<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>0BTC Wire Browser Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 2rem;
            padding-bottom: 2rem;
            background-color: #f8f9fa;
        }
        .header {
            margin-bottom: 2rem;
            border-bottom: 1px solid #e5e5e5;
            padding-bottom: 1rem;
        }
        .card {
            margin-bottom: 1.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        .card-header {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        pre {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.25rem;
            max-height: 200px;
            overflow-y: auto;
        }
        .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .btn-success {
            background-color: #198754;
            border-color: #198754;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header text-center">
            <h1>0BTC Wire Browser Demo</h1>
            <p class="lead">Zero-Knowledge UTXO System for Wrapped Bitcoin and Native Assets</p>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Key Generation
                    </div>
                    <div class="card-body">
                        <p>Generate a new Ed25519 keypair for use with 0BTC Wire.</p>
                        <button id="generate-keypair" class="btn btn-primary">Generate Keypair</button>
                        <div id="keypair-result" class="mt-3" style="display: none;">
                            <h5>Generated Keypair:</h5>
                            <pre id="keypair-json"></pre>
                            <button id="copy-keypair" class="btn btn-sm btn-secondary">Copy to Clipboard</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        Create Wrapped Asset Mint Proof
                    </div>
                    <div class="card-body">
                        <p>Create a proof for minting wrapped Bitcoin.</p>
                        <form id="mint-form">
                            <div class="mb-3">
                                <label for="recipient-pk-hash" class="form-label">Recipient Public Key Hash (hex)</label>
                                <input type="text" class="form-control" id="recipient-pk-hash" value="0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef">
                            </div>
                            <div class="mb-3">
                                <label for="amount" class="form-label">Amount (satoshis)</label>
                                <input type="number" class="form-control" id="amount" value="100000000">
                            </div>
                            <div class="mb-3">
                                <label for="salt" class="form-label">Salt (hex)</label>
                                <input type="text" class="form-control" id="salt" value="0xfedcba0987654321fedcba0987654321fedcba0987654321fedcba0987654321">
                            </div>
                            <div class="mb-3">
                                <label for="custodian-pk-x" class="form-label">Custodian Public Key X (hex)</label>
                                <input type="text" class="form-control" id="custodian-pk-x" value="0x1111111111111111111111111111111111111111111111111111111111111111">
                            </div>
                            <div class="mb-3">
                                <label for="custodian-pk-y" class="form-label">Custodian Public Key Y (hex)</label>
                                <input type="text" class="form-control" id="custodian-pk-y" value="0x2222222222222222222222222222222222222222222222222222222222222222">
                            </div>
                            <button type="submit" class="btn btn-primary">Create Proof</button>
                        </form>
                        <div id="mint-result" class="mt-3" style="display: none;">
                            <h5>Generated Proof:</h5>
                            <pre id="mint-proof-json"></pre>
                            <button id="copy-mint-proof" class="btn btn-sm btn-secondary">Copy to Clipboard</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Verify Proof
                    </div>
                    <div class="card-body">
                        <p>Verify a proof for any circuit type.</p>
                        <form id="verify-form">
                            <div class="mb-3">
                                <label for="circuit-type" class="form-label">Circuit Type</label>
                                <select class="form-select" id="circuit-type">
                                    <option value="WrappedAssetMint">WrappedAssetMint</option>
                                    <option value="WrappedAssetBurn">WrappedAssetBurn</option>
                                    <option value="Transfer">Transfer</option>
                                    <option value="NativeAssetCreate">NativeAssetCreate</option>
                                    <option value="NativeAssetMint">NativeAssetMint</option>
                                    <option value="NativeAssetBurn">NativeAssetBurn</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="proof-json" class="form-label">Proof JSON</label>
                                <textarea class="form-control" id="proof-json" rows="10" placeholder="Paste proof JSON here"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Verify Proof</button>
                        </form>
                        <div id="verify-result" class="mt-3" style="display: none;">
                            <div id="verify-success" class="alert alert-success" style="display: none;">
                                <strong>Success!</strong> Proof is valid.
                            </div>
                            <div id="verify-failure" class="alert alert-danger" style="display: none;">
                                <strong>Failure!</strong> Proof is invalid.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        Console Output
                    </div>
                    <div class="card-body">
                        <pre id="console-output" style="max-height: 300px;"></pre>
                        <button id="clear-console" class="btn btn-sm btn-secondary">Clear Console</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import the WASM module
        import init, { generate_keypair, prove_wrapped_asset_mint, verify_proof } from './wire_lib.js';

        // Redirect console.log to our custom console
        const originalConsoleLog = console.log;
        console.log = function() {
            // Call the original console.log
            originalConsoleLog.apply(console, arguments);
            
            // Add to our custom console
            const consoleOutput = document.getElementById('console-output');
            const args = Array.from(arguments);
            consoleOutput.textContent += args.join(' ') + '\n';
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        };

        // Initialize the WASM module
        async function initWasm() {
            try {
                await init();
                console.log('WASM module initialized successfully');
            } catch (e) {
                console.error('Failed to initialize WASM module:', e);
                alert('Failed to initialize WASM module. See console for details.');
            }
        }

        // Generate keypair
        document.getElementById('generate-keypair').addEventListener('click', async () => {
            try {
                const keypair = generate_keypair();
                const keypairJson = JSON.stringify(keypair, null, 2);
                document.getElementById('keypair-json').textContent = keypairJson;
                document.getElementById('keypair-result').style.display = 'block';
                console.log('Generated keypair successfully');
            } catch (e) {
                console.error('Failed to generate keypair:', e);
                alert('Failed to generate keypair. See console for details.');
            }
        });

        // Copy keypair to clipboard
        document.getElementById('copy-keypair').addEventListener('click', () => {
            const keypairJson = document.getElementById('keypair-json').textContent;
            navigator.clipboard.writeText(keypairJson).then(() => {
                console.log('Keypair copied to clipboard');
            });
        });

        // Create wrapped asset mint proof
        document.getElementById('mint-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const recipientPkHash = document.getElementById('recipient-pk-hash').value;
                const amount = parseInt(document.getElementById('amount').value);
                const salt = document.getElementById('salt').value;
                const custodianPkX = document.getElementById('custodian-pk-x').value;
                const custodianPkY = document.getElementById('custodian-pk-y').value;

                const attestationData = {
                    recipientPkHash,
                    amount,
                    salt
                };

                const custodianPk = {
                    x: custodianPkX,
                    y: custodianPkY
                };

                const proof = prove_wrapped_asset_mint(attestationData, custodianPk);
                const proofJson = JSON.stringify(proof, null, 2);
                document.getElementById('mint-proof-json').textContent = proofJson;
                document.getElementById('mint-result').style.display = 'block';
                
                // Also populate the verify form with this proof
                document.getElementById('proof-json').value = proofJson;
                document.getElementById('circuit-type').value = 'WrappedAssetMint';
                
                console.log('Generated wrapped asset mint proof successfully');
            } catch (e) {
                console.error('Failed to create proof:', e);
                alert('Failed to create proof. See console for details.');
            }
        });

        // Copy mint proof to clipboard
        document.getElementById('copy-mint-proof').addEventListener('click', () => {
            const proofJson = document.getElementById('mint-proof-json').textContent;
            navigator.clipboard.writeText(proofJson).then(() => {
                console.log('Proof copied to clipboard');
            });
        });

        // Verify proof
        document.getElementById('verify-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const circuitType = document.getElementById('circuit-type').value;
                const proofJson = document.getElementById('proof-json').value;
                const proof = JSON.parse(proofJson);

                const isValid = verify_proof(proof, circuitType);
                
                document.getElementById('verify-result').style.display = 'block';
                if (isValid) {
                    document.getElementById('verify-success').style.display = 'block';
                    document.getElementById('verify-failure').style.display = 'none';
                } else {
                    document.getElementById('verify-success').style.display = 'none';
                    document.getElementById('verify-failure').style.display = 'block';
                }
                
                console.log(`Proof verification result: ${isValid ? 'Valid' : 'Invalid'}`);
            } catch (e) {
                console.error('Failed to verify proof:', e);
                alert('Failed to verify proof. See console for details.');
            }
        });

        // Clear console
        document.getElementById('clear-console').addEventListener('click', () => {
            document.getElementById('console-output').textContent = '';
        });

        // Initialize when the page loads
        window.addEventListener('load', initWasm);
    </script>
</body>
</html>
